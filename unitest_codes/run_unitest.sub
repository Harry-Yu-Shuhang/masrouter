#!/bin/bash

#SBATCH --partition=3090                     # âœ… ä½¿ç”¨ 3090 åˆ†åŒº
#SBATCH --nodelist=aisurrey12                # âœ… æŒ‡å®š 3090 ç©ºé—²èŠ‚ç‚¹
#SBATCH --job-name=masrouter_3090            # âœ… ä»»åŠ¡åç§°
#SBATCH --nodes=1                            # âœ… 1 ä¸ªèŠ‚ç‚¹
#SBATCH --ntasks=1                           # âœ… å¯åŠ¨ 1 ä¸ªè¿›ç¨‹ï¼ˆå’Œ GPU å¯¹åº”ï¼‰
#SBATCH --gpus-per-node=1                    # âœ… æ¯èŠ‚ç‚¹ 1 å¼  GPU
#SBATCH --cpus-per-task=8                    # âœ… æ¯è¿›ç¨‹ 8 æ ¸ CPU
#SBATCH --time=12:00:00                      # âœ… æœ€é•¿è¿è¡Œ 12 å°æ—¶
#SBATCH --mem=64G                            # âœ… ç”³è¯·å†…å­˜
#SBATCH --output=output.log                  # âœ… æ ‡å‡†è¾“å‡ºæ—¥å¿—
#SBATCH --error=error.log                    # âœ… é”™è¯¯æ—¥å¿—

echo "ðŸ” ä»»åŠ¡å¼€å§‹ï¼Œå½“å‰ç›®å½•: $(pwd)" > output.log
cd $SLURM_SUBMIT_DIR || { echo "âŒ ç›®å½•ä¸å­˜åœ¨ï¼Œé€€å‡º"; exit 1; }
echo "ðŸ“Œ è¿›å…¥ç›®å½•: $SLURM_SUBMIT_DIR" >> output.log

# âœ… è®¾å®š CUDA å†…å­˜ç®¡ç†ç­–ç•¥
export PYTORCH_CUDA_ALLOC_CONF="expandable_segments:True"

# âœ… åŠ è½½ module ç³»ç»Ÿ
if [ -f /etc/profile.d/modules.sh ]; then
    source /etc/profile.d/modules.sh
else
    echo "âš ï¸ modules.sh æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡ module ç›¸å…³æ“ä½œ" >> output.log
fi

# âœ… åŠ è½½ CUDAï¼ˆé€‚é… 3090ï¼Œå»ºè®® CUDA 11.8ï¼‰
AVAILABLE_CUDA=$(module spider cuda 2>&1 | grep -Eo 'cuda/11\.8' | tail -n1)
if [[ -n "$AVAILABLE_CUDA" ]]; then
    module load $AVAILABLE_CUDA
    echo "âœ… åŠ è½½ CUDA ç‰ˆæœ¬: $AVAILABLE_CUDA" >> output.log
else
    echo "âš ï¸ æ‰¾ä¸åˆ° CUDA 11.8ï¼Œå°è¯•ä½¿ç”¨ç³»ç»Ÿ CUDA" >> output.log
fi

# âœ… æ£€æŸ¥ GPU
echo "ðŸ” GPU è®¾å¤‡ä¿¡æ¯ï¼š" >> output.log
nvidia-smi >> output.log 2>>error.log || { echo "âš ï¸ GPU æ£€æµ‹å¤±è´¥ï¼Œå¯èƒ½ä½¿ç”¨ CPU" >> output.log; }

# âœ… æ¿€æ´» uv çŽ¯å¢ƒ
echo "ðŸš€ æ¿€æ´» uv çŽ¯å¢ƒ" >> output.log
pip install uv >> output.log 2>>error.log || { echo "âš ï¸ uv å®‰è£…å¤±è´¥" >> output.log; }
echo "ðŸš€ å‡çº§ transformers..." >> output.log
uv pip install "transformers>=4.38.0" --upgrade >> output.log 2>> error.log
uv sync >> output.log 2>>error.log || { echo "âš ï¸ uv sync å¤±è´¥" >> output.log; }

# âœ… è¿è¡Œè®­ç»ƒè„šæœ¬
echo "ðŸš€ å¼€å§‹å•å…ƒæµ‹è¯•." >> output.log
uv run unitest/unitest.py >> output.log 2>>error.log || { echo "âŒ è®­ç»ƒå¤±è´¥" >> output.log; exit 1; }

echo "âœ… ä»»åŠ¡å®Œæˆ" >> output.log
